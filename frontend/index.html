<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta name="api-base-url" content="http://<서버IP>:8000"> -->
    <title>AUTOISMS - Security Automation Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Sidebar Toggle -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        GUIDE
    </button>

    <!-- Left Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="guide-section" id="guideSection">
                <div class="guide-header" onclick="toggleGuide()">
                    <div>
                        <h3>워크플로우 가이드</h3>
                        <div class="sidebar-subtitle">KISA 보안 점검 절차</div>
                    </div>
                    <button class="guide-toggle-btn">▼</button>
                </div>
                <div class="guide-content">
                    <div class="guide-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Inventory 탐색</h4>
                            <p>Ansible 인벤토리에서 타겟 서버를 자동으로 불러옵니다</p>
                        </div>
                    </div>
                    <div class="guide-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>연결 확인</h4>
                            <p>타겟 서버들의 SSH 연결 상태를 확인합니다</p>
                        </div>
                    </div>
                    <div class="guide-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>보안 진단</h4>
                            <p>KISA 가이드 기반으로 취약점을 스캔합니다</p>
                        </div>
                    </div>
                    <div class="guide-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h4>취약점 조치</h4>
                            <p>발견된 취약점을 자동으로 조치합니다</p>
                        </div>
                    </div>
                    <div class="guide-step">
                        <div class="step-number">5</div>
                        <div class="step-content">
                            <h4>회귀 감지</h4>
                            <p>외부 패치로 인한 보안 회귀를 자동 감지합니다</p>
                        </div>
                    </div>
                    <div class="guide-step">
                        <div class="step-number">6</div>
                        <div class="step-content">
                            <h4>보고서 생성</h4>
                            <p>진단 및 조치 결과를 PDF/Excel로 생성합니다</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="horizontal-resizer" id="horizontalResizer"></div>

            <div class="terminal-section" id="terminalSection">
                <div class="terminal-header">
                    <span>시스템 로그</span>
                    <span class="log-badge" id="logCount">0</span>
                </div>
                <div class="terminal-logs" id="terminalLogs">
                    <div class="log-entry info">
                        <span class="log-time">[00:00:00]</span>
                        <span>System initialized</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-left">
                <a href="#" class="logo">
                    <div class="logo-icon">🔒</div>
                    <span>AUTOISMS</span>
                </a>
                <!-- <span class="badge" style="background: #f8fafc; color: #658c99;">코드</span>
                <span class="badge" style="background: #bae7e4; color: #354a52;">카테고리</span>
                <span class="badge" style="background: #fee2e2; color: #991b1b;">위험도 높음</span>
                <span class="badge" style="background: #fef3c7; color: #92400e;">위험도 낮음</span>
                <span class="badge" style="background: #fee2e2; color: #991b1b;">상태 취약</span>
                <span class="badge" style="background: #d1fae5; color: #065f46;">상태 정상</span>
                <span class="badge" style="background: #78716c; color: #fff;">수동조치필요</span>
                <span class="badge" style="background: #6366f1; color: #fff;">상세 로그</span> -->
                <ul class="nav-links">
                    <li><a href="#dashboard">Dashboard</a></li>
                    <li><a href="#servers">Servers</a></li>
                    <li><a href="#reports">Reports</a></li>
                </ul>
            </div>
            <div class="nav-right">
                <div class="theme-switch-wrap" title="다크/라이트 모드 전환">
                    <button type="button" id="themeSwitch" class="theme-switch-btn" role="switch" aria-label="다크 모드 전환">
                        <span class="theme-switch-track">
                            <span class="theme-switch-knob"></span>
                        </span>
                        <span class="theme-switch-icon theme-switch-dark" aria-hidden="true">🌙</span>
                        <span class="theme-switch-icon theme-switch-light" aria-hidden="true">☀️</span>
                    </button>
                </div>
                <div class="snapshot-badge" id="snapshotBadge">
                    <span>Snapshot #0</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-wrapper" id="mainWrapper">
        <div class="container">

            <!-- Initial Setup Page -->
            <div class="page active" id="initialPage">
                <div class="card">
                    <div class="setup-container">
                        <div class="setup-icon">🗂️</div>
                        <h1 class="setup-title">Ansible Inventory 불러오기</h1>
                        <p class="setup-desc">
                            메인 서버의 Ansible 설정 파일을 분석하여 관리 대상 서버 목록을 자동으로 가져옵니다
                        </p>
                        <button class="btn btn-primary" onclick="loadInventory()">
                            <span>📡</span>
                            <span>Inventory 확인</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Target Server List Page -->
            <div class="page" id="targetListPage">
                <!-- 1. KPI 숫자 카드 (SOC 스타일) -->
                <div class="stats-grid" id="statsDashboard">
                    <div class="stat-card">
                        <div class="stat-value" id="totalServers" style="color: var(--primary)">0</div>
                        <div class="stat-label">전체 서버</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="connectedServers" style="color: var(--success)">0</div>
                        <div class="stat-label">연결됨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalVulns" style="color: var(--danger)">0</div>
                        <div class="stat-label">총 취약점</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="regressionServers" style="color: var(--warning)">0</div>
                        <div class="stat-label">회귀 발생</div>
                    </div>
                </div>

                <!-- 2. 카테고리별 취약점(레이더) + 상태별 분포(파이) -->
                <div class="dashboard-charts-row">
                    <div class="chart-cell chart-cell-radar" style="min-width: 0;">
                        <div class="chart-container" id="chartContainer" style="display: none; height: 280px; padding: 20px;">
                            <div class="chart-title" style="text-align: center; margin-bottom: 12px; font-size: 15px;">카테고리별 취약점 분포</div>
                            <div style="height: calc(100% - 40px); position: relative;">
                                <canvas id="vulnChart"></canvas>
                            </div>
                        </div>
                        <div class="card chart-placeholder-card" id="chartPlaceholder" style="text-align: center; padding: 40px 20px; height: 280px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.2;">📊</div>
                            <div style="color: var(--text-secondary); font-size: 13px; line-height: 1.8;">
                                진단 완료 후<br>
                                카테고리별 취약점<br>
                                분포가 표시됩니다
                            </div>
                        </div>
                    </div>
                    <div class="chart-cell chart-cell-pie" style="min-width: 0;">
                        <div class="chart-container" id="pieChartContainer" style="height: 280px; overflow: hidden;">
                            <div class="chart-title">상태별 분포</div>
                            <div style="height: calc(100% - 36px); position: relative; overflow: hidden;">
                                <canvas id="statusPieChart"></canvas>
                            </div>
                            <div id="pieChartPlaceholder" class="chart-placeholder" style="display: none;">
                                <span class="chart-placeholder-icon">🥧</span>
                                <span>진단 완료 후 취약/수동/양호 비율이 표시됩니다</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. 취약점 추이 (라인) -->
                <div style="margin-bottom: 24px;">
                    <div class="chart-container" id="lineChartContainer" style="height: 340px;">
                        <div class="chart-title">취약점 추이</div>
                        <div style="height: calc(100% - 36px); position: relative;">
                            <canvas id="trendChart"></canvas>
                        </div>
                        <div id="lineChartPlaceholder" class="chart-placeholder" style="display: none;">
                            <span class="chart-placeholder-icon">📈</span>
                            <span>진단 이력이 있는 서버의 취약점 추이가 표시됩니다</span>
                        </div>
                    </div>
                </div>

                <!-- Server Management Card -->
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <h2 class="card-title">타겟 서버 관리</h2>
                            <p class="card-subtitle">Ansible Inventory에서 불러온 서버 목록</p>
                        </div>
                        <div style="display: inline-flex; align-items: center; gap: 8px;">
                            <button type="button" class="btn btn-primary" id="addServerBtn" onclick="openAddServerModal()" style="display: inline-flex; align-items: center; gap: 6px;">
                                <span>+</span>
                                <span>서버 추가</span>
                            </button>
                            <button type="button" class="btn btn-secondary" id="deleteSelectedBtn" onclick="deleteSelectedServers()" disabled style="display: inline-flex; align-items: center; gap: 6px;">
                                <span>🗑️</span>
                                <span>선택 삭제</span>
                            </button>
                            <button type="button" class="btn btn-secondary" id="deleteAllServersBtn" onclick="deleteAllServers()" style="display: inline-flex; align-items: center; gap: 6px;">
                                <span>🗑️</span>
                                <span>전체 삭제</span>
                            </button>
                        </div>
                    </div>

                    <!-- Control Panel -->
                    <div class="control-panel" style="position: static; top: auto;">
                        <div class="control-row">
                            <div class="search-box">
                                <input type="text" class="search-input" id="searchInput" placeholder="IP 주소 또는 호스트명 검색..." onkeyup="searchTargets()">
                                <span class="search-icon">🔍</span>
                            </div>
                        </div>
                        <div class="control-row">
                            <div class="btn-group">
                                <button class="btn btn-secondary" id="diagnoseSelectedBtn" onclick="diagnoseSelected()" disabled>
                                    <span>🔍</span>
                                    <span>선택 진단</span>
                                </button>
                                <button class="btn btn-primary" id="diagnoseAllBtn" onclick="diagnoseAll()">
                                    <span>🔍</span>
                                    <span>전체 진단</span>
                                </button>
                                <button class="btn btn-success" id="fixAllTargetsBtn" onclick="fixAllTargets()" style="display: none;">
                                    <span>🔧</span>
                                    <span>전체 조치</span>
                                </button>
                            </div>
                            <div class="btn-group" style="margin-left: 12px;">
                                <button class="btn btn-primary" id="diagnosisReportBtn" onclick="openReportFormatModal('diagnosis')" style="display: none;">
                                    <span>📄</span>
                                    <span>전체 진단 보고서</span>
                                </button>
                                <button class="btn btn-secondary" id="diagnosisIndividualsExcelBtn" onclick="downloadDiagnosisIndividualsExcel()" style="display: none;" title="각 서버별 진단 데이터가 시트별로 담긴 Excel">
                                    <span>📊</span>
                                    <span>개별 진단 (Excel)</span>
                                </button>
                                <button class="btn btn-success" id="remediationReportBtn" onclick="openReportFormatModal('remediation')" style="display: none;">
                                    <span>📋</span>
                                    <span>전체 조치 보고서</span>
                                </button>
                                <button class="btn btn-secondary" id="remediationIndividualsExcelBtn" onclick="downloadRemediationIndividualsExcel()" style="display: none;" title="각 서버별 조치 데이터가 시트별로 담긴 Excel">
                                    <span>📊</span>
                                    <span>개별 조치 (Excel)</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                    <th class="sortable" onclick="sortTable('ip')">서버 IP</th>
                                    <th class="sortable" onclick="sortTable('hostname')">호스트명</th>
                                    <th class="sortable" onclick="sortTable('connected')">연결</th>
                                    <th class="sortable" onclick="sortTable('vulnCount')">취약점</th>
                                    <th class="sortable" onclick="sortTable('regression')">회귀</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="targetTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>

                        <div id="noResults" class="empty-state" style="display: none;">
                            <div class="empty-icon">🔍</div>
                            <div class="empty-text">검색 결과가 없습니다</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Server Modal -->
    <div class="modal" id="addServerModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h2 class="modal-title">서버 추가</h2>
                <button class="close-btn" onclick="closeAddServerModal()">&times;</button>
            </div>
            <div style="padding: 0 24px 24px;">
                <p class="card-subtitle" style="margin-bottom: 16px;">Ansible inventory에 등록할 서버 정보를 입력하세요. 등록 후 목록이 새로고침됩니다.</p>
                <form id="addServerForm" onsubmit="return submitAddServer(event);">
                    <div style="display: grid; gap: 14px;">
                        <div>
                            <label for="addServerHostname" style="display: block; font-weight: 600; margin-bottom: 4px; font-size: 14px;">호스트명</label>
                            <input type="text" id="addServerHostname" required placeholder="예: target1" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label for="addServerIp" style="display: block; font-weight: 600; margin-bottom: 4px; font-size: 14px;">서버 IP</label>
                            <input type="text" id="addServerIp" required placeholder="예: 192.168.1.10" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label for="addServerPort" style="display: block; font-weight: 600; margin-bottom: 4px; font-size: 14px;">SSH 포트</label>
                            <input type="number" id="addServerPort" value="22" min="1" max="65535" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label for="addServerUsername" style="display: block; font-weight: 600; margin-bottom: 4px; font-size: 14px;">SSH 사용자명</label>
                            <input type="text" id="addServerUsername" value="root" placeholder="root" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    <div class="add-server-terms" style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;">Ansible 접속 요구사항 (필수 확인)</div>
                        <ul style="margin: 0; padding-left: 20px; color: #475569; font-size: 13px; line-height: 1.7;">
                            <li><code style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px;">ssh_private_key_file</code>은 <strong>/home/main/.ssh/id_rsa</strong>에 저장되어 있어야 합니다.</li>
                            <li>입력하신 호스트는 <strong>root 권한</strong>이 있는 서버여야 합니다.</li>
                            <li><strong>visudo</strong>에서 해당 사용자에게 <strong>NOPASSWD</strong>가 등록되어 있어야 합니다. (become 비밀번호 없이 실행)</li>
                        </ul>
                        <label style="display: flex; align-items: flex-start; gap: 10px; margin-top: 12px; cursor: pointer; font-size: 14px;">
                            <input type="checkbox" id="addServerTermsAgree" style="margin-top: 3px;">
                            <span>위 조건을 확인했으며, 해당 서버가 위 요구사항을 만족합니다. 동의합니다.</span>
                        </label>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeAddServerModal()">취소</button>
                        <button type="submit" class="btn btn-primary" id="addServerSubmitBtn">
                            <span>등록</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTargetTitle">서버 상세</h2>
                <button class="close-btn" onclick="closeDetailModal()">&times;</button>
            </div>
            <div id="modalRegressionInfo" class="modal-regression-info" style="display: none;"></div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortModalTable('code')">코드</th>
                            <th class="sortable" onclick="sortModalTable('name')">취약점명</th>
                            <th class="sortable" onclick="sortModalTable('category')">카테고리</th>
                            <th class="sortable" onclick="sortModalTable('severity')">위험도</th>
                            <th class="sortable" onclick="sortModalTable('status')">상태</th>
                            <th>로그</th>
                            <th>조치</th>
                        </tr>
                    </thead>
                    <tbody id="modalVulnTableBody">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeDetailModal()">닫기</button>
                <button class="btn" style="background: #3b82f6; color: white;" onclick="openReportFormatModal('server_diagnosis', currentTargetIP)">
                    <span>📄</span>
                    <span>진단 보고서</span>
                </button>
                <button class="btn btn-success" id="modalRemediationReportBtn" onclick="openReportFormatModal('server_remediation', currentTargetIP)" style="display: none;">
                    <span>📋</span>
                    <span>조치 보고서</span>
                </button>
                <button class="btn btn-primary" onclick="fixAllVulnerabilitiesInModal()">
                    <span>🔧</span>
                    <span>전체 조치</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Report Format Modal (전체 진단/조치 보고서 형식 선택 - 각 버튼별로 별도 모달) -->
    <div class="modal" id="reportFormatModal" onclick="if(event.target===this)closeReportFormatModal()">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">
                <h2 class="modal-title" id="reportFormatModalTitle">보고서 형식 선택</h2>
                <button class="close-btn" onclick="closeReportFormatModal()">&times;</button>
            </div>
            <div style="padding: 24px;">
                <p class="card-subtitle" style="margin-bottom: 20px; color: var(--text-secondary);">다운로드할 형식을 선택하세요.</p>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-primary" style="justify-content: center; padding: 14px;" onclick="selectReportFormat('pdf')">
                        <span>📄</span>
                        <span>PDF</span>
                    </button>
                    <button class="btn btn-secondary" style="justify-content: center; padding: 14px;" onclick="selectReportFormat('csv')">
                        <span>📊</span>
                        <span>CSV</span>
                    </button>
                    <button class="btn btn-secondary" style="justify-content: center; padding: 14px;" onclick="selectReportFormat('json')">
                        <span>📋</span>
                        <span>JSON</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal" id="progressModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="progress-content">
                <div class="progress-icon" id="progressIcon">⏳</div>
                <h2 class="progress-title" id="progressTitle">진행 중...</h2>
                <p class="progress-desc" id="progressDesc">잠시만 기다려주세요</p>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-percent">
                    <span id="progressPercent">0</span>%
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/operations.js"></script>
    <script src="js/modal.js"></script>
    <script src="js/reports.js"></script>
    <script src="js/init.js"></script>
    <!-- <script src="js/app.js"></script> -->
</body>
</html>